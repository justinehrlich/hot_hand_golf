---
title: "HMM_v2"
output: html_document
date: "2025-09-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
cards <- readRDS("scorecards_cleaned_all.rds")
cards
```

```{r}
cards_prepped <- cards %>%
  arrange(playerId, year, tournId, DayIndex, holeOrderNumber) %>%
  group_by(playerId, year, tournId) %>%
  mutate(
    sequence_id = cur_group_id(),   
    hole_index = row_number()
  ) %>%
  ungroup() %>%
  filter(!is.na(strokes_gained)) %>%   
  mutate(orgId = factor(orgId))
```

```{r}
cards_prepped <- cards_prepped %>%
  group_by(sequence_id) %>%
  filter(n() > 17) %>%  
  ungroup()
```

```{r}
cards_prepped_pga <- cards_prepped %>% filter(orgId == "PGA")
```


```{r}
# Cap extreme values at Â±5
cards_prepped$sg_cap <- pmax(pmin(cards_prepped$strokes_gained, 5), -5)

# Standardize for numerical stability
cards_prepped$sg_std <- scale(cards_prepped$sg_cap)
```

```{r}
ntimes_vec <- as.numeric(table(cards_prepped$sequence_id))
summary(ntimes_vec)  
```

```{r}
n_states <- 2  # Hot vs Cold

hmm_data <- cards_prepped %>%
  arrange(sequence_id, hole_index) %>%
  dplyr::select(sg_std, orgId, sequence_id)

hmm_model <- depmix(
  response = sg_std ~ 1,
  data = hmm_data,
  nstates = n_states,
  family = gaussian(),
  ntimes = ntimes_vec
)
```

```{r}
set.seed(787654378)

hmm_fit <- fit(
  hmm_model,
  emcontrol = em.control(maxit = 100, tol = 1e-6),  # control convergence
  verbose = TRUE
)
```

```{r}
summary(hmm_fit)
```





